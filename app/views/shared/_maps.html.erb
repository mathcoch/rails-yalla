<div id="map" style="width: 100%; height: 100%;"></div>


<% content_for(:js) do %>
  <script>
    $(document).ready(function() {

      console.log("hello");

      var activities = <%= raw map_hash.to_json %>;
      var markers = [];
      var map;
      var stylesLight = [{"featureType":"water","elementType":"geometry","stylers":[{"color":"#e9e9e9"},{"lightness":17}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"lightness":17}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#ffffff"},{"lightness":29},{"weight":0.2}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":18}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":16}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":21}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#dedede"},{"lightness":21}]},{"elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"lightness":16}]},{"elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#333333"},{"lightness":40}]},{"elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f2f2f2"},{"lightness":19}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#fefefe"},{"lightness":20}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#fefefe"},{"lightness":17},{"weight":1.2}]}];
      var styledMap = new google.maps.StyledMapType(stylesLight, {name: "Styled Map"});
      var mapOptions = {
        zoom: 8,
        center: new google.maps.LatLng(48.8566, 2.3522),
        mapTypeControlOptions: {
          mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
        }
      };

      var bounds  = new google.maps.LatLngBounds();

      initMap();
      console.log("drop ? ")
      drop();
      console.log("dropped !")


      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), mapOptions);
        map.setOptions({styles: stylesLight});
        // map.mapTypes.set('map_style', styledMap);
        // map.setMapTypeId('map_style');
      }


      function drop() {
        clearMarkers();
        for (var i = 0; i < activities.length; i++) {
          addMarkerWithTimeoutandLabel(activities[i], i, i * 300);
          loc = new google.maps.LatLng(activities[i].lat, activities[i].lng);
          bounds.extend(loc);
          map.fitBounds(bounds);
          map.panToBounds(bounds);
        }
      }

      function addMarkerWithTimeoutandLabel(position, index, timeout) {
        window.setTimeout(function() {

          // ensure proper sizing of image
          if (position.picture == null){
            var image = { url: "http://maps.google.com/mapfiles/ms/micons/yellow.png" };
          } else {
            var image = { url: position.picture };
          }
          // create marker
          var marker = new google.maps.Marker({
            position: position,
            map: map,
            label: String(position.label),
            animation: google.maps.Animation.DROP,
            icon: image
          });

          // if (image.url) {
          //   marker.icon = image;
          // }
          // create infowindow
          var infowindow = new google.maps.InfoWindow({
            content: position.infowindow
          });
          // add infowindow to marker
          marker.addListener('click', function(){
            infowindow.open(map, marker);
          });
          markers.push(marker);

        }, timeout); // end of timeoue

      } // end of add marker

      function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
        markers = [];
      }

    });

  </script>
<% end %>

