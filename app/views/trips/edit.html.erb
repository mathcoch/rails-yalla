<div class="trip-edit-wrapper">
  <div class="container-fuid heigth100">
    <div class="row-fluid text-center heigth100">
      <div class="col-xs-12 col-sm-2 heigth100">
      <!-- Activities not assigned + Add new activity module -->
        <p>Unassigned(<%= image_tag @trip_icons[0] %>)</p>
        <button type="button" class="btn btn-g" data-toggle="modal" data-target="#modal_establishment">Add Establishment</button>
        <%= render 'activities/form_new_activity_by_establishment', activity: @activity, trip: @trip, main_categories: @main_categories %>
        <div id="grid-0" class="activity-grid works-grid works-grid-gut works-hover-w sortable accordion heigth100 brd-grey">
          <% @activities.where(trip_day: nil).order(index: :asc).each do |act| %>
            <%= render 'activities/card_activity_index', activity: act %>
          <% end %>
        </div>
      </div>

      <div class="col-xs-12 col-sm-6 heigth100">
      <!-- Trip Days and Itiniraries -->
        <p>Trip day by day</p>
        <div class="row width100 inblock brd-grey heigth100">
          <% @trip_days.each do |td| %>
            <div class="col-xs-4 inblock trip-day heigth100">
              <div id="grid-<%= td.id %>" class="activity-grid works-grid works-grid-gut works-hover-w sortable accordion heigth100">
              <p><%= td.title %>(<%= image_tag @trip_icons[td.id] %>)</p>
                <% @activities.where(trip_day: td).order(index: :asc).each do |act| %>
                  <%= render 'activities/card_activity_index', activity: act %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <div class="col-xs-12 col-sm-4 heigth100">

        <!-- Magic button -->
        <div class="other_container" style="width: 100%; height: 10%;">
          <%= button_to "Make my day !", make_my_day_trip_path(@trip), class: "btn btn-lg btn-success", method: :put %>
        </div>
        <!-- Map, to do, references, etc... -->
        <div class="map_container" style="width: 100%; height: 50%;">
          <%= render 'shared/maps', map_hash: @map_hash %>
        </div>
        <!-- Description of the trip to edit -->
        <div class="other_container" style="width: 100%; height: 30%;">
          <%= @trip.description %>
        </div>
      </div>
    </div>
  </div>
</div>

<% content_for(:js) do %>
  <script>
    $(document).ready(function() {
      // TODO Check safety!!!
      var AUTH_TOKEN = $('meta[name=csrf-token]').attr('content');

      // SORTING !!!
      // Define all lists you can connect together
      var connectable_lists = "#grid-0";
      var days = $('.trip-day .sortable');
      for (var i = 0; i < days.length; i++) {
         connectable_lists = connectable_lists.concat(", #" + days[i].id);
         console.log(days[i].id)
      }

      $( connectable_lists ).sortable({
          connectWith: ".sortable",
          placeholder: "placeholder-highlight ui-corner-all",
          handle: ".activity-item-header",
          cancel: ".activity-item-toggle",
          stop: function( event, ui ) {
            savePosition(event, ui)
          }
      });

      $( ".accordion" ).accordion({
        header: "> div > div.activity-item-header",
        collapsible: true,
        heightStyle: "content",
        active: false
      });

      // document.getElementById( 'ui' ).style.display = 'none';

      function savePosition(event, ui) {
        // check why this ?
        var element = $(this);
        // define update parameters to save
        var activity_id = ui.item[0].id.split("-").pop(); // get the id of the element
        var day = ui.item[0].parentElement.id.split("-").pop();
        //var day = $(".activity-grid").index(ui.item[0].parentElement); // get the column parent
        var index = $("#grid-" + day + " .activity-item").index(ui.item) + 1; // get the index inside the column
        var data = {
          activity: {
            trip_day_id: day,
            index: index
          },
          authenticity_token: AUTH_TOKEN
        };

        $.ajax({
          type: 'PUT',
          url: '/activities/' + activity_id + '/change_position/',
          data: data,
          success: function(data) {
            console.log(data);
            // callback(data); // return data in callback
          },
          error: function(jqXHR) {
            console.error(jqXHR.responseText);
          }
        });
      }
    });
  </script>
<% end %>
